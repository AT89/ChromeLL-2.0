<html>
<head>
<script type="text/javascript" src="App/src/vars.json"></script>
<script type="text/javascript" src="App/src/allBg.js"></script>
<script type="text/javascript">
var board = Array();
var cfg;
(localStorage['ChromeLL-Config'] == undefined) ? cfg = {} : cfg = JSON.parse(localStorage['ChromeLL-Config']);

var app = chrome.app.getDetails();
if(localStorage['ChromeLL-Version'] != app.version){
    console.log('ChromeLL updated! Old v: ' + localStorage['ChromeLL-Version'] + " New v: " + app.version);
    localStorage['ChromeLL-Version'] = app.version;
}

function buildContextMenu()
{
    board = null;
    board = Array();
    var id;
    var menu = chrome.contextMenus.create({"title": "ETI", "contexts":["page"] });
    for(var i in boards){
        if(boards[i] != boards[0]){
            chrome.contextMenus.create({"type":"separator", "parentId":menu});
        }
        for(var j in boards[i]){
            id = chrome.contextMenus.create({"title": j, "parentId": menu, "onclick":handleContext});
            board[id] = boards[i][j];
        }
    }
}
function handleContext(info){
    if(board[info.menuItemId] % 1 === 0){
        chrome.tabs.create({"url":"http://boards.endoftheinter.net/showtopics.php?board=" + board[info.menuItemId]});
    }else{
        var url = board[info.menuItemId].replace("%extension%", chrome.extension.getURL("/"));
        chrome.tabs.create({"url":url});
    }
}
buildContextMenu();

function handleHttpsRedirect(dest){
    return { redirectUrl: dest.url.replace(/^http/i, "https")}
}

for(var i in allBg.activeListeners){
    allBg.activeListeners[i] = cfg[i];
    console.log('setting: ' + i + " " + allBg.activeListeners[i]);
}
allBg.init_listener(cfg);

chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
        switch(request.need){
            case "config":
                sendResponse({"data":JSON.parse(localStorage['ChromeLL-Config'])});
                cfg = JSON.parse(localStorage['ChromeLL-Config']);
                break;
            case "save":
                cfg[request.name] = request.data;
                localStorage['ChromeLL-Config'] = JSON.stringify(cfg);
                break;
            case "notify":
                var notification = webkitNotifications.createNotification(
                    'Style/images/lueshi_48.png',
                    request.title,
                    request.message);
                notification.show();
                if(cfg.close_notifications){
                    setTimeout(function(){notification.cancel();}, (parseInt(cfg.close_notification_time) * 1000));
                }
                break;
            defaiult:
                console.log("Error in request listener - undefined parameter?", request);
                break;
        }
    });
</script>
</head>
</html>  