<html>
<head>
<script type="text/javascript" src="App/src/vars.json"></script>
<script type="text/javascript" src="App/src/allBg.js"></script>
<script type="text/javascript">
var board = Array();
var cfg;
var drama = {};
(localStorage['ChromeLL-Config'] == undefined) ? cfg = {} : cfg = JSON.parse(localStorage['ChromeLL-Config']);

var app = chrome.app.getDetails();
if(localStorage['ChromeLL-Version'] != app.version){
    console.log('ChromeLL updated! Old v: ' + localStorage['ChromeLL-Version'] + " New v: " + app.version);
    localStorage['ChromeLL-Version'] = app.version;
}

function buildContextMenu()
{
    board = null;
    board = Array();
    var id;
    var menu = chrome.contextMenus.create({"title": "ETI", "contexts":["page"] });
    for(var i in boards){
        if(boards[i] != boards[0]){
            chrome.contextMenus.create({"type":"separator", "parentId":menu});
        }
        for(var j in boards[i]){
            id = chrome.contextMenus.create({"title": j, "parentId": menu, "onclick":handleContext});
            board[id] = boards[i][j];
        }
    }
}
function handleContext(info){
    if(board[info.menuItemId] % 1 === 0){
        chrome.tabs.create({"url":"http://boards.endoftheinter.net/showtopics.php?board=" + board[info.menuItemId]});
    }else{
        var url = board[info.menuItemId].replace("%extension%", chrome.extension.getURL("/"));
        chrome.tabs.create({"url":url});
    }
}
function getDrama() {
    console.log('getting dramalinks');
    var dramas;
    var xhr = new XMLHttpRequest();
	xhr.open("GET", "http://wiki.endoftheinter.net/index.php?title=Dramalinks/current&action=raw&section=0&maxage=30", true);		
	xhr.send();
	xhr.onreadystatechange = function(){
		if(xhr.readyState == 4) {
			var t = xhr.responseText;
            t=t.replace(/\[\[(.+?)(\|(.+?))\]\]/g,"<a href=\"http://wiki.endoftheinter.net/index.php/$1\">$3</a>");
			t=t.replace(/\[\[(.+?)\]\]/g,"<a href=\"http://wiki.endoftheinter.net/index.php/$1\">$1</a>");
			t=t.replace(/\[(.+?)\]/g,"<a href=\"$1\" style=\"padding-left: 0px\"><img src=\"http://wiki.endoftheinter.net/skins/monobook/external.png\"></a>");
			t=t.replace(/href="\/index\.php/g,"href=\"http://wiki.endoftheinter.net/index.php");
			t=t.replace(/style=/gi,"");
			t=t.replace(/<script/gi,"<i");
			t=t.replace(/(on)([A-Za-z]*)(=)/gi,"");
			t=t.slice(t.indexOf("<!--- NEW STORIES GO HERE --->")+29);
			dramas=t.slice(0,t.indexOf("<!--- NEW STORIES END HERE --->"));
			t=t.slice(t.indexOf("<!--- CHANGE DRAMALINKS COLOR CODE HERE --->"));
			t=t.slice(t.indexOf("{{")+2);
			var bgcol=t.slice(0,t.indexOf("}}"));
			var col;
			var kermit=false;
			switch (bgcol.toLowerCase()){
                case "kermit":
                    document.getElementById("dramalinks_ticker").style.border="2px solid #990099";
					bgcol="black";
					kermit=true;
                case "black":
				case "blue":
				case "green":
                    col="white";
					break;
                default:
					col="black";
					break;
			}
            if (!kermit)				{
				dramas="<span style='text-transform:capitalize'>Current Dramalinks Level: <font color='" + bgcol + "'>" + bgcol + "</font></span><div style='background-color: "+bgcol+"; color: "+col+";'>" + dramas.slice(2).replace(/\*/g,"&nbsp;&nbsp;&nbsp;&nbsp;")+"</div>";
            }else{
                dramas="Current Dramalinks Level: <blink><font color='" + bgcol + "'>CODE KERMIT</font></blink><div style='background-color: "+bgcol+"; color: "+col+";'>" + dramas.slice(2).replace(/\*/g,"&nbsp;&nbsp;&nbsp;&nbsp;")+"</div>";
            }
            drama.txt = dramas;
            drama.time = new Date().getTime();
        }
    }
    //return drama;
}
buildContextMenu();

function handleHttpsRedirect(dest){
    return { redirectUrl: dest.url.replace(/^http/i, "https")}
}

for(var i in allBg.activeListeners){
    allBg.activeListeners[i] = cfg[i];
    console.log('setting: ' + i + " " + allBg.activeListeners[i]);
}
allBg.init_listener(cfg);

chrome.extension.onRequest.addListener(
    function(request, sender, sendResponse) {
        switch(request.need){
            case "config":
                sendResponse({"data":JSON.parse(localStorage['ChromeLL-Config'])});
                cfg = JSON.parse(localStorage['ChromeLL-Config']);
                break;
            case "save":
                cfg[request.name] = request.data;
                localStorage['ChromeLL-Config'] = JSON.stringify(cfg);
                break;
            case "notify":
                var notification = webkitNotifications.createNotification(
                    'Style/images/lueshi_48.png',
                    request.title,
                    request.message);
                notification.show();
                if(cfg.close_notifications){
                    setTimeout(function(){notification.cancel();}, (parseInt(cfg.close_notification_time) * 1000));
                }
                break;
            case "dramalinks":
                console.log('need dramalinks');
                var time = parseInt(new Date().getTime()) + (1800 * 1000);
                if(drama.time && (drama.time < time)){
                    console.log('returning cached dramalinks. cache time: ' + drama.time + ' -> ' + time);
                    sendResponse({"data": drama.txt});
                }else{
                    getDrama();
                    console.log('getting new drama', drama);
                    sendResponse({"data":drama.txt});
                }
                break;
            default:
                console.log("Error in request listener - undefined parameter?", request);
                break;
        }
    });
</script>
</head>
</html>  